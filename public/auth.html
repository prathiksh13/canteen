<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auth</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="wrap">
    <h1>Login / Signup</h1>
    <div class="grid">
      <div class="panel">
        <div class="row"><div class="pill">Signup</div></div>
        <div class="row"><input id="s_name" placeholder="Name" /></div>
        <div class="row"><input id="s_email" placeholder="Email" /></div>
        <div class="row"><input id="s_phone" placeholder="Phone" /></div>
        <div class="row"><select id="s_role"><option value="student">Student</option><option value="staff">Staff</option><option value="admin">Admin</option></select></div>
        <div class="row"><input id="s_password" type="password" placeholder="Password" /></div>
        <div class="row"><button id="signup">Signup</button></div>
      </div>
      <div class="panel">
        <div class="row"><div class="pill">Login</div></div>
        <div class="row"><input id="l_email" placeholder="Email" /></div>
        <div class="row"><input id="l_phone" placeholder="Phone" /></div>
        <div class="row"><input id="l_password" type="password" placeholder="Password" /></div>
        <div class="row"><button id="login">Login</button></div>
      </div>
      <div class="panel">
        <div class="row"><div class="pill">Session</div></div>
        <div id="me" class="row"></div>
        <div class="row"><button id="logout">Logout</button><a class="card" href="/">Home</a></div>
      </div>
      <div class="panel">
        <div class="row"><div class="pill">Temp Credentials</div></div>
        <div class="row">Admin: admin@canteen.local / admin123</div>
        <div class="row">Staff: staff@canteen.local / staff123</div>
        <div class="row">Student: student@canteen.local / student123</div>
      </div>
    </div>
  </div>
  <script>
    const tokenKey = 'token';
    const setToken = t => localStorage.setItem(tokenKey, t);
    const getToken = () => localStorage.getItem(tokenKey);
    const clearToken = () => localStorage.removeItem(tokenKey);
    const loadMe = async () => {
      const t = getToken();
      if (!t) { document.getElementById('me').textContent = 'No session'; return; }
      const r = await fetch('/api/auth/me', { headers: { 'Authorization': 'Bearer ' + t } });
      if (r.ok) {
        const u = await r.json();
        document.getElementById('me').textContent = `${u.name} (${u.role}) â€¢ ${u.id}`;
      } else {
        document.getElementById('me').textContent = 'Session invalid';
      }
    };
    document.getElementById('signup').onclick = async () => {
      const body = {
        name: document.getElementById('s_name').value,
        email: document.getElementById('s_email').value || null,
        phone: document.getElementById('s_phone').value || null,
        role: document.getElementById('s_role').value,
        password: document.getElementById('s_password').value
      };
      const r = await fetch('/api/auth/signup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const x = await r.json();
      if (r.ok) { setToken(x.token); window.location.href = '/'; } else { alert(JSON.stringify(x)); }
    };
    document.getElementById('login').onclick = async () => {
      const body = {
        email: document.getElementById('l_email').value || null,
        phone: document.getElementById('l_phone').value || null,
        password: document.getElementById('l_password').value
      };
      const r = await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const x = await r.json();
      if (r.ok) { setToken(x.token); window.location.href = '/'; } else { alert(JSON.stringify(x)); }
    };
    document.getElementById('logout').onclick = async () => {
      const t = getToken();
      if (t) await fetch('/api/auth/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + t } });
      clearToken();
      loadMe();
    };
    loadMe();
  </script>
</body>
</html>
